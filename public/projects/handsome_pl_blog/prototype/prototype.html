<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handsome Programming Languages</title>
    <link rel="icon" type="png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .screen {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        .screen.active {
            display: block;
        }

        /* Scene fade overlay */
        .scene-fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            transition: opacity 5s ease-in-out;
        }

        .scene-fade-overlay.fading {
            opacity: 1;
            pointer-events: all;
        }

        /* HOME SCREEN AND BG */
        .home-screen {
            width: 100%;
            height: 100vh;
            background-image: url('images/homescreen1.png');
            background-size: cover;
            background-position: center;
            color: white;
            position: relative;
            display: flex;
            align-items: center;
        }

        .home-content {
            margin-left: 60px;
            max-width: 500px;
        }

        .home-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        .home-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            text-align: left;
        }

        .menu-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            margin: 10px 0;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: block;
            width: 300px;
            height: 75px;
        }

        .menu-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Visual novel screen */
        .vn-screen {
            background-size: cover;
            background-position: center;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23ff9a9e;stop-opacity:1" /><stop offset="100%" style="stop-color:%23fecfef;stop-opacity:1" /></linearGradient></defs><rect width="1200" height="800" fill="url(%23bg)"/></svg>');
            transition: background-image 0.8s ease-in-out;
        }

        .split-screen {
            display: flex;
            height: 100vh;
        }

        .vn-side {
            flex: 1;
            position: relative;
        }

        .code-side {
            flex: 1;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
        }

        /* Characters */
        .characters {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 50px;
            z-index: 2;
        }

        .character {
            height: 900px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .character.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .character.static {
            opacity: 1;
            transform: none;
            transition: none;
        }

        .character-sprite {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .character-fallback {
            height: 900px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        .character-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .character-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 0 0 10px 10px;
            text-align: center;
        }

        .character-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Slide-in animations */
        .character.slide-in-left {
            opacity: 0;
            transform: translateX(-100vw);
            animation: slideInLeft 0.6s ease-out forwards;
        }

        .character.slide-in-right {
            opacity: 0;
            transform: translateX(100vw);
            animation: slideInRight 0.6s ease-out forwards;
        }

        .character.bounce {
            animation: expressionBounce 0.4s ease-in-out;
        }

        @keyframes slideInLeft {
            0% {
                opacity: 0;
                transform: translateX(-100vw);
            }
            70% {
                transform: translateX(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            0% {
                opacity: 0;
                transform: translateX(100vw);
            }
            70% {
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes expressionBounce {
            0% { transform: scale(1) translateY(0); }
            25% { transform: scale(0.95) translateY(-10px); }
            50% { transform: scale(1.05) translateY(-5px); }
            75% { transform: scale(0.98) translateY(-2px); }
            100% { transform: scale(1) translateY(0); }
        }

        .character.slide-out-left {
            animation: slideOutLeft 0.5s ease-in forwards;
        }

        .character.slide-out-right {
            animation: slideOutRight 0.5s ease-in forwards;
        }

        @keyframes slideOutLeft {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(-100vw); }
        }

        @keyframes slideOutRight {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100vw); }
        }

        /* UI Controls */
        .ui-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .control-button {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            width: 100px;
            transition: background 0.3s ease;
        }

        .control-button:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .settings-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            display: none;
            width: 200px;
        }

        .settings-panel.open {
            display: block;
        }

        .setting-item {
            margin: 10px 0;
            color: white;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .setting-item input {
            margin-right: 10px;
        }

        /* Text box */
        .text-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            color: white;
            z-index: 5;
            backdrop-filter: blur(10px);
        }

        .speaker-name {
            font-weight: bold;
            color: #ff9a9e;
            margin-bottom: 10px;
        }

        .text-content {
            line-height: 1.6;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .next-button {
            background: #ff9a9e;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .next-button:hover {
            background: #ff8a94;
        }

        .back-button {
            background: #667eea;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .back-button:hover {
            background: #5a6fd8;
        }

        /* Code sandbox styles */
        .code-header {
            background: #2d2d2d;
            color: white;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid #444;
        }

        .code-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .code-input {
            flex: 1;
            background: #1e1e1e;
            color: #f8f8f2;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .code-controls {
            background: #2d2d2d;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .code-button {
            background: #007acc;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .code-button:hover {
            background: #005999;
        }

        .code-output {
            background: #0d1117;
            color: #f0f6fc;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #444;
        }

        .challenge-info {
            background: #2d2d2d;
            color: white;
            padding: 15px;
            border-bottom: 1px solid #444;
            font-size: 14px;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        @media (max-width: 768px) {
            .split-screen {
                flex-direction: column;
            }
            .vn-side, .code-side {
                flex: none;
                height: 50vh;
            }
        }
    </style>
</head>

<body>
    <!-- Scene fade overlay -->
    <div class="scene-fade-overlay" id="scene-fade-overlay"></div>

    <!-- HOME SCREEN -->
    <div class="screen active" id="home-screen">
        <div class="home-screen">
            <div class="home-content">
                <h1 class="home-title">Handsome Programming Languages üíª</h1>
                <p class="home-subtitle">Fall in love with code... literally!!</p>
                <button class="menu-button" onclick="startStory()">Start Story</button>
                <button class="menu-button" onclick="showScreen('coding-screen')">Coding Challenge</button>
            </div>
        </div>
    </div>

    <!-- VISUAL NOVEL SCREEN -->
    <div class="screen" id="vn-screen">
        <div class="vn-screen">
            <div class="ui-controls">
                <button class="control-button" onclick="showScreen('home-screen')">üè† Home</button>
                <button class="control-button" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
                <div class="settings-panel" id="settings-panel">
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="music-toggle" checked>
                            BGM
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="auto-play" checked>
                            Auto-play Text
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="range" id="text-speed" min="1" max="5" value="3">
                            Text Speed
                        </label>
                    </div>
                </div>
            </div>

            <div class="characters" id="characters"></div>

            <div class="text-box">
                <div class="speaker-name" id="speaker-name">Java</div>
                <div class="text-content" id="text-content">
                    Welcome to the Programming Academy!
                </div>
                <div style="display: flex; justify-content: flex-end; align-items: center; min-height: 40px;">
                    <button class="back-button" id="back-button" onclick="previousDialogue()" style="display: none; margin-right: auto;">Back</button>
                    <button class="next-button" onclick="console.log('Next button clicked!'); nextDialogue()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CODING CHALLENGE SCREEN -->
    <div class="screen" id="coding-screen">
        <div class="split-screen">
            <div class="vn-side">
                <div class="ui-controls">
                    <button class="control-button" onclick="showScreen('home-screen')">üè† Home</button>
                    <button class="control-button" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
                </div>

                <div class="characters" id="characters-coding"></div>

                <div class="text-box">
                    <div class="speaker-name" id="speaker-name-coding">Python</div>
                    <div class="text-content" id="text-content-coding">
                        Ready for a coding challenge?
                    </div>
                    <div style="display: flex; justify-content: flex-end; align-items: center; min-height: 40px;">
                        <button class="back-button" id="back-button-coding" onclick="previousCodingDialogue()" style="display: none; margin-right: auto;">Back</button>
                        <button class="next-button" onclick="console.log('Coding next button clicked!'); nextCodingDialogue()">Next</button>
                    </div>
                </div>
            </div>

            <div class="code-side">
                <div class="code-header">Python Challenge: First Date</div>
                <div class="challenge-info" id="challenge-info">
                    Write a function called 'greet_python' that takes a name as input and returns "Hello [name], nice to meet you!"
                </div>
                <div class="code-container">
                    <textarea class="code-input" id="code-input" placeholder="# Write your code here...
def greet_python(name):
    # Your code here
    pass"></textarea>
                    <div class="code-controls">
                        <button class="code-button" onclick="runCode()">Run Code</button>
                        <button class="code-button" onclick="checkSolution()">Check Solution</button>
                        <button class="code-button" onclick="clearCode()">Clear</button>
                    </div>
                    <div class="code-output" id="code-output">Ready to code! üíñ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === GAME CONFIGURATION ===
        const GameConfig = {
            fadeTransitions: true, // Set to false to disable scene fading
            fadeDuration: 3000,     // Fade duration in milliseconds
            autoAdvanceDelay: 3000 // Auto-advance delay (if enabled)
        };

        // === CHARACTER DEFINITIONS ===
        const Characters = {
            java: {
                name: "The Janitor",
                description: "Robust and Responsible",
                emoji: "‚ö°",
                moods: {
                    neutral: "images/java_normal.png",
                    happy: "images/java_blush.png",
                    waiting: "images/java_waiting.png",
                    mad: "images/java_mad.png"
                }
            },
            python: {
                name: "Peethon", 
                description: "Elegant & Readable",
                emoji: "üêç",
                moods: {
                    neutral: "images/python_normal.png",
                    happy: "images/python_normal2.png",
                    upset: "images/python_mad.png",
                    blushing: "images/python_blush.png"
                }
            },
            c: {
                name: "Cee",
                description: "Reliable & Fast",
                emoji: "‚öîÔ∏è",
                moods: {
                    neutral: "images/c_talk.png",
                    happy: "images/c_blush.png"
                }
            },
            windows: {
                name: "Windoe",
                description: "Good Operating Sysem",
                emoji: "‚öîÔ∏è",
                moods: {
                    neutral: "images/windows_normal.png",
                    smile: "images/windows_smile.png",
                    blushing: "images/windows_blushing.png",
                    talking1: "images/windows_bend_talk.png"
                    
                }
            },
             you: {
                name: "You",
                emoji: "üßç",
                moods: {
 
                    
                }
            },



        };

        // === STORY STRUCTURE ===
        const Stories = {
            main: {
                title: "Main Story",
                background: "url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 1200 800\"><defs><linearGradient id=\"bg\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\"><stop offset=\"0%\" style=\"stop-color:%23ff9a9e;stop-opacity:1\" /><stop offset=\"100%\" style=\"stop-color:%23fecfef;stop-opacity:1\" /></linearGradient></defs><rect width=\"1200\" height=\"800\" fill=\"url(%23bg)\"/></svg>')",
                scenes: [
                    {
                        id: "intro",
                        background: null, // Use story default
                        useFade: true,
                        dialogue: [
                            {
                                speaker: "???",
                                text: "..hey. HEY. Wake up! are you with us?",
                                characters: [
                                    { id: "windows", mood: "talking1", side: "left" }
                                ],
                                actions: [],
                                showBack: false
                            },
                                                        {
                            speaker: "You",
                                text: "Huh...? One moment I was at my desk at Am*zon, and suddenly I'm here...where am I?",
                                characters: [
                                    { id: "you", mood: "talking1", side: "left" }
                                ],
                                actions: [],
                                showBack: true
                            },
                            {
                                speaker: "???",
                                text:  "GOOD MORNING!! our cutie intern is finally awake! How are you feeling!",
                                characters: [
                                    { id: "windows", mood: "smile", side: "static" }
                                ],
                                actions: [],
                                showBack: true // Allow going back from here
                            },
                            {
                                speaker: "java", 
                                text: "Are you ready to meet some of the most handsome languages in the digital world?",
                                characters: [
                                    { id: "java", mood: "happy", side: "left" }
                                ],
                                showBack: true
                            },
                            {
                                speaker: "java",
                                text: "Let me introduce you to some of my friends. Each of us has our own unique personality and strengths.",
                                characters: [
                                    { id: "java", mood: "neutral", side: "left" },
                                    { id: "python", mood: "neutral", side: "right" },
                                    { id: "c", mood: "neutral", side: "center" }
                                ],
                                showBack: true
                            }
                        ]
                    },
                    {
                        id: "meet_python",
                        useFade: true,
                        dialogue: [
                            {
                                speaker: "python",
                                text: "Greetings! I'm Python. I believe in clean, readable code and elegant solutions.",
                                characters: [
                                    { id: "python", mood: "happy", side: "center" }
                                ],
                                showBack: true
                            },
                            {
                                speaker: "python",
                                text: "Some say I'm the most approachable language... would you like to find out? üíï",
                                characters: [
                                    { id: "python", mood: "blushing", side: "center" }
                                ],
                                showBack: true
                            }
                        ]
                    },
                    {
                        id: "meet_c", 
                        useFade: false, // Example of no fade
                        dialogue: [
                            {
                                speaker: "c",
                                text: "I am C. I may seem intimidating at first, but I offer power and performance like no other.",
                                characters: [
                                    { id: "c", mood: "neutral", side: "center" }
                                ],
                                showBack: true
                            },
                            {
                                speaker: "c",
                                text: "Are you brave enough to handle my complexity?",
                                characters: [
                                    { id: "c", mood: "happy", side: "center" }
                                ],
                                showBack: true
                            }
                        ]
                    }
                ]
            },
            coding: {
                title: "Coding Challenge",
                background: null,
                scenes: [
                    {
                        id: "python_challenge",
                        dialogue: [
                            {
                                speaker: "python",
                                text: "Hello there! I'm Python, and I have a special challenge for you. Show me you can handle my elegant syntax! üíï",
                                characters: [
                                    { id: "python", mood: "happy", side: "center" }
                                ],
                                showBack: false // First dialogue in coding mode
                            },
                            {
                                speaker: "python",
                                text: "I love how you think! Your approach to problem-solving is quite... attractive. Ready for the next challenge?",
                                characters: [
                                    { id: "python", mood: "blushing", side: "center" }
                                ],
                                showBack: true
                            }
                        ]
                    }
                ]
            }
        };

        // === GAME STATE ===
        let gameState = {
            currentScreen: 'home-screen',
            currentStory: null,
            currentScene: 0,
            currentDialogue: 0
        };

        // Save game state using URL parameters (works in artifacts)
        function saveGameState() {
            console.log('Saving game state:', gameState);
            const params = new URLSearchParams();
            params.set('story', gameState.currentStory || '');
            params.set('scene', gameState.currentScene.toString());
            params.set('dialogue', gameState.currentDialogue.toString());
            params.set('screen', gameState.currentScreen);
            
            const newUrl = window.location.pathname + '?' + params.toString();
            console.log('New URL:', newUrl);
            window.history.replaceState({}, '', newUrl);
        }

        // Load game state from URL parameters
        function loadGameState() {
            const params = new URLSearchParams(window.location.search);
            console.log('Loading from URL params:', params.toString());
            
            const story = params.get('story');
            const scene = params.get('scene');
            const dialogue = params.get('dialogue');
            const screen = params.get('screen');
            
            console.log('Parsed values:', { story, scene, dialogue, screen });
            
            if (story && story !== '') {
                gameState.currentStory = story;
                gameState.currentScene = parseInt(scene || '0');
                gameState.currentDialogue = parseInt(dialogue || '0');
                gameState.currentScreen = screen || 'vn-screen';
                console.log('Game state loaded:', gameState);
                return true;
            }
            console.log('No saved state found');
            return false;
        }

        // === CORE FUNCTIONS ===

        // Scene fade functionality
        function fadeScene(callback, duration = GameConfig.fadeDuration) {
            if (!GameConfig.fadeTransitions) {
                if (callback) callback();
                return;
            }

            const overlay = document.getElementById('scene-fade-overlay');
            overlay.classList.add('fading');

            setTimeout(() => {
                if (callback) callback();
                
                setTimeout(() => {
                    overlay.classList.remove('fading');
                }, 100);
            }, duration / 2);
        }

        // Screen management with optional fading
        function showScreen(screenId, useFade = false) {
            const transitionFn = () => {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                gameState.currentScreen = screenId;
                saveGameState(); // Save state when changing screens

                // Initialize screen-specific content
                if (screenId === 'vn-screen' && gameState.currentStory) {
                    displayCurrentDialogue();
                } else if (screenId === 'coding-screen') {
                    initializeCodingScreen();
                }
            };

            if (useFade) {
                fadeScene(transitionFn);
            } else {
                transitionFn();
            }
        }

        // Start story with optional scene selection
        function startStory(storyName = 'main', sceneIndex = 0) {
            gameState.currentStory = storyName;
            gameState.currentScene = sceneIndex;
            gameState.currentDialogue = 0;
            saveGameState();

            const story = Stories[storyName];
            const scene = story.scenes[sceneIndex];
            
            showScreen('vn-screen', scene.useFade);
        }

        // Display current dialogue
        function displayCurrentDialogue() {
            const story = Stories[gameState.currentStory];
            const scene = story.scenes[gameState.currentScene];
            const dialogue = scene.dialogue[gameState.currentDialogue];

            if (!dialogue) return;

            // Update text
            document.getElementById('speaker-name').textContent = dialogue.speaker;
            document.getElementById('text-content').textContent = dialogue.text;

            // Show/hide back button based on dialogue settings
            const backButton = document.getElementById('back-button');
            if (dialogue.showBack !== undefined) {
                backButton.style.display = dialogue.showBack ? 'block' : 'none';
            } else {
                // Default: show back button if not the first dialogue
                backButton.style.display = gameState.currentDialogue > 0 ? 'block' : 'none';
            }

            // Update background if specified
            if (scene.background) {
                document.querySelector('.vn-screen').style.backgroundImage = scene.background;
            } else if (story.background) {
                document.querySelector('.vn-screen').style.backgroundImage = story.background;
            }

            // Display characters
            displayCharacters(dialogue.characters, 'characters');

            // Execute any actions
            if (dialogue.actions) {
                dialogue.actions.forEach(action => executeAction(action));
            }
        }

        // Execute story actions (mood changes, etc.)
        function executeAction(action) {
            switch (action.type) {
                case 'mood_change':
                    setTimeout(() => {
                        changeCharacterMood(action.character, action.mood);
                    }, action.delay || 0);
                    break;
                case 'scene_transition':
                    setTimeout(() => {
                        gameState.currentScene = action.sceneIndex;
                        gameState.currentDialogue = 0;
                        displayCurrentDialogue();
                    }, action.delay || 0);
                    break;
            }
        }

        // Enhanced character display
        function displayCharacters(characterData, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            characterData.forEach((charData, index) => {
                const char = Characters[charData.id];
                if (!char) return;

                const charElement = document.createElement('div');
                charElement.className = 'character';
                charElement.setAttribute('data-character', charData.id);
                charElement.setAttribute('data-mood', charData.mood);

                // Add static class for static characters to remove all animations
                if (charData.side === 'static') {
                    charElement.classList.add('static');
                }

                // For static characters, preload the image to avoid placeholder flash
                if (charData.side === 'static' && char.moods && char.moods[charData.mood]) {
                    const img = new Image();
                    img.onload = function() {
                        // Image loaded successfully, create element with image
                        charElement.innerHTML = `
                            <img src="${char.moods[charData.mood]}" alt="${char.name} (${charData.mood})" class="character-sprite">
                        `;
                        // No need to set opacity or add visible class for static characters
                    };
                    img.onerror = function() {
                        // Image failed to load, use fallback
                        charElement.innerHTML = `
                            <div class="character-fallback">
                                <div class="character-emoji">${char.emoji}</div>
                            </div>
                        `;
                        // No need to set opacity or add visible class for static characters
                    };
                    // Start loading the image
                    img.src = char.moods[charData.mood];
                    
                } else {
                    // Non-static characters - create fallback first
                    charElement.innerHTML = `
                        <div class="character-fallback">
                            <div class="character-emoji">${char.emoji}</div>
                        </div>
                    `;
                }

                container.appendChild(charElement);

                // Apply animations only for non-static characters
                if (charData.side !== 'static') {
                    // Slide animation
                    const slideDirection = charData.side === 'center' ? (index % 2 === 0 ? 'left' : 'right') : 
                                          charData.side === 'left' ? 'left' : 'right';

                    setTimeout(() => {
                        charElement.classList.add(`slide-in-${slideDirection}`);
                        setTimeout(() => {
                            charElement.classList.add('visible');
                            charElement.classList.remove(`slide-in-${slideDirection}`);
                        }, 600);
                    }, index * 200);

                    // Load mood image for non-static characters (after animation starts)
                    if (char.moods && char.moods[charData.mood]) {
                        const img = new Image();
                        img.onload = function() {
                            charElement.innerHTML = `
                                <img src="${char.moods[charData.mood]}" alt="${char.name} (${charData.mood})" class="character-sprite">
                            `;
                        };
                        img.src = char.moods[charData.mood];
                    }
                } else {
                    // Static characters with no image - show fallback immediately
                    if (!char.moods || !char.moods[charData.mood]) {
                        charElement.innerHTML = `
                            <div class="character-fallback">
                                <div class="character-emoji">${char.emoji}</div>
                            </div>
                        `;
                    }
                }
            });
        }

        // Enhanced mood changing
        function changeCharacterMood(characterId, newMood, containerId = null) {
            const containers = containerId ? [containerId] : ['characters', 'characters-coding'];
            
            containers.forEach(cId => {
                const container = document.getElementById(cId);
                if (!container) return;

                const charElement = container.querySelector(`[data-character="${characterId}"]`);
                if (!charElement) return;

                const char = Characters[characterId];
                if (!char || !char.moods || !char.moods[newMood]) return;

                charElement.classList.add('bounce');
                setTimeout(() => charElement.classList.remove('bounce'), 400);

                charElement.setAttribute('data-mood', newMood);

                setTimeout(() => {
                    const img = new Image();
                    img.onload = function() {
                        charElement.innerHTML = `
                            <img src="${char.moods[newMood]}" alt="${char.name} (${newMood})" class="character-sprite">
                        `;
                    };
                    img.onerror = function() {
                        charElement.innerHTML = `
                            <div class="character-fallback">
                                <div class="character-emoji">${char.emoji}</div>
                            </div>
                        `;
                    };
                    img.src = char.moods[newMood];
                }, 150);
            });
        }

        // Dialogue advancement
        function nextDialogue() {
            console.log('nextDialogue() called, current state:', gameState);
            const story = Stories[gameState.currentStory];
            const scene = story.scenes[gameState.currentScene];
            
            gameState.currentDialogue++;
            console.log('About to save state after dialogue increment');
            saveGameState(); // Save state when advancing dialogue
            
            if (gameState.currentDialogue >= scene.dialogue.length) {
                // Move to next scene or end story
                gameState.currentScene++;
                gameState.currentDialogue = 0;
                saveGameState(); // Save state when advancing scene
                
                if (gameState.currentScene >= story.scenes.length) {
                    // Story finished - could transition to coding or back to menu
                    if (gameState.currentStory === 'main') {
                        showScreen('coding-screen', true);
                        gameState.currentStory = 'coding';
                        gameState.currentScene = 0;
                        gameState.currentDialogue = 0;
                        saveGameState();
                    } else {
                        showScreen('home-screen', true);
                    }
                    return;
                }
                
                // Check if next scene uses fade
                const nextScene = story.scenes[gameState.currentScene];
                if (nextScene.useFade) {
                    fadeScene(() => displayCurrentDialogue());
                } else {
                    displayCurrentDialogue();
                }
            } else {
                displayCurrentDialogue();
            }
        }

        // Coding screen initialization
        function initializeCodingScreen() {
            gameState.currentStory = 'coding';
            gameState.currentScene = 0;
            gameState.currentDialogue = 0;
            saveGameState();
            displayCodingDialogue();
        }

        function displayCodingDialogue() {
            const story = Stories[gameState.currentStory];
            const scene = story.scenes[gameState.currentScene];
            const dialogue = scene.dialogue[gameState.currentDialogue];

            if (!dialogue) return;

            document.getElementById('speaker-name-coding').textContent = dialogue.speaker;
            document.getElementById('text-content-coding').textContent = dialogue.text;
            
            // Show/hide back button for coding screen
            const backButton = document.getElementById('back-button-coding');
            if (dialogue.showBack !== undefined) {
                backButton.style.display = dialogue.showBack ? 'block' : 'none';
            } else {
                backButton.style.display = gameState.currentDialogue > 0 ? 'block' : 'none';
            }
            
            displayCharacters(dialogue.characters, 'characters-coding');
        }

        function nextCodingDialogue() {
            const story = Stories[gameState.currentStory];
            const scene = story.scenes[gameState.currentScene];
            
            gameState.currentDialogue++;
            saveGameState();
            
            if (gameState.currentDialogue >= scene.dialogue.length) {
                gameState.currentDialogue = 0; // Loop in coding mode
                saveGameState();
            }
            
            displayCodingDialogue();
        }

        // Back button functionality
        function previousDialogue() {
            console.log('previousDialogue() called, current state:', gameState);
            
            if (gameState.currentDialogue > 0) {
                gameState.currentDialogue--;
                saveGameState();
                displayCurrentDialogue();
            } else if (gameState.currentScene > 0) {
                // Go to previous scene's last dialogue
                gameState.currentScene--;
                const story = Stories[gameState.currentStory];
                const scene = story.scenes[gameState.currentScene];
                gameState.currentDialogue = scene.dialogue.length - 1;
                saveGameState();
                displayCurrentDialogue();
            }
        }

        function previousCodingDialogue() {
            console.log('previousCodingDialogue() called, current state:', gameState);
            
            if (gameState.currentDialogue > 0) {
                gameState.currentDialogue--;
                saveGameState();
                displayCodingDialogue();
            }
        }

        // Settings management
        function toggleSettings() {
            const settingsPanel = gameState.currentScreen === 'coding-screen' ?
                document.getElementById('settings-panel-2') || document.getElementById('settings-panel') :
                document.getElementById('settings-panel');
            if (settingsPanel) {
                settingsPanel.classList.toggle('open');
            }
        }

        // === CODE CHALLENGE SYSTEM ===
        const challenges = {
            current: {
                description: "Write a function called 'greet_python' that takes a name as input and returns 'Hello [name], nice to meet you!'",
                solution: function(code) {
                    try {
                        if (code.includes('def greet_python') &&
                            code.includes('return') &&
                            code.includes('Hello') &&
                            code.includes('nice to meet you')) {
                            return { 
                                success: true, 
                                message: "Perfect! Python is impressed with your elegant solution! üíñ" 
                            };
                        } else {
                            return { 
                                success: false, 
                                message: "Hmm, that's not quite right. Make sure you define 'greet_python' and return the correct greeting!" 
                            };
                        }
                    } catch (error) {
                        return { 
                            success: false, 
                            message: "There's an error in your code: " + error.message 
                        };
                    }
                }
            }
        };

        function runCode() {
            const code = document.getElementById('code-input').value;
            const output = document.getElementById('code-output');

            output.innerHTML = `<div style="color: #4caf50;">Code executed! Here's what would happen:</div>
                               <div>${code.replace(/\n/g, '<br>')}</div>
                               <div style="margin-top: 10px; color: #ff9a9e;">Ready to check your solution?</div>`;
        }

        function checkSolution() {
            const code = document.getElementById('code-input').value;
            const output = document.getElementById('code-output');
            const result = challenges.current.solution(code);

            output.innerHTML = `<div class="${result.success ? 'success' : 'error'}">${result.message}</div>`;

            if (result.success) {
                changeCharacterMood('python', 'happy', 'characters-coding');
                setTimeout(() => {
                    document.getElementById('text-content-coding').textContent =
                        "Wonderful! Your code is as beautiful as your mind. I think this could be the start of something special... üíï";
                }, 1000);
            } else {
                changeCharacterMood('python', 'upset', 'characters-coding');
            }
        }

        function clearCode() {
            document.getElementById('code-input').value = `# Write your code here...
def greet_python(name):
    # Your code here
    pass`;
            document.getElementById('code-output').textContent = "Code cleared! Ready for a fresh start! üíñ";
        }

        // === UTILITY FUNCTIONS FOR EASY CONTENT ADDITION ===

        // Add new character easily
        function addCharacter(id, data) {
            Characters[id] = data;
        }

        // Add new story easily  
        function addStory(id, storyData) {
            Stories[id] = storyData;
        }

        // Add scene to existing story
        function addScene(storyId, sceneData) {
            if (Stories[storyId]) {
                Stories[storyId].scenes.push(sceneData);
            }
        }

        // Add dialogue to existing scene
        function addDialogue(storyId, sceneIndex, dialogueData) {
            if (Stories[storyId] && Stories[storyId].scenes[sceneIndex]) {
                Stories[storyId].scenes[sceneIndex].dialogue.push(dialogueData);
            }
        }

        // === INITIALIZATION ===
        window.onload = function() {
            console.log('Game starting...');
            console.log('Current URL:', window.location.href);
            console.log('URL search params:', window.location.search);
            console.log('Available Stories:', Object.keys(Stories));
            console.log('Available Characters:', Object.keys(Characters));
            
            // Try to load saved state and restore game position
            const hasState = loadGameState();
            console.log('Has saved state:', hasState);
            
            if (hasState && gameState.currentStory) {
                console.log('Restoring to:', gameState);
                
                // Properly restore the screen and content
                if (gameState.currentScreen === 'vn-screen') {
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.remove('active');
                    });
                    document.getElementById('vn-screen').classList.add('active');
                    displayCurrentDialogue();
                } else if (gameState.currentScreen === 'coding-screen') {
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.remove('active');
                    });
                    document.getElementById('coding-screen').classList.add('active');
                    displayCodingDialogue();
                } else {
                    showScreen(gameState.currentScreen, false);
                }
            } else {
                console.log('No state to restore, showing home screen');
                showScreen('home-screen');
            }
        };

        // === EXAMPLES OF HOW TO ADD CONTENT ===
        
        // Example: Add a new character
        /*
        addCharacter('javascript', {
            name: "JavaScript",
            description: "Dynamic & Versatile", 
            emoji: "‚ö°",
            moods: {
                neutral: "images/js_normal.png",
                excited: "images/js_excited.png",
                confused: "images/js_confused.png"
            }
        });
        */

        // Example: Add a new story
        /*
        addStory('bonus', {
            title: "Bonus Content",
            background: "url('images/bonus_bg.jpg')",
            scenes: [
                {
                    id: "secret_meeting",
                    useFade: true,
                    dialogue: [
                        {
                            speaker: "javascript",
                            text: "Psst! Over here! I have something special to show you...",
                            characters: [
                                { id: "javascript", mood: "excited", side: "left" }
                            ]
                        }
                    ]
                }
            ]
        });
        */

        // Example: Add dialogue to existing story
        /*
        addDialogue('main', 0, {
            speaker: "java",
            text: "Oh, and one more thing before we continue...",
            characters: [
                { id: "java", mood: "happy", side: "center" }
            ],
            actions: [
                { type: 'mood_change', character: 'java', mood: 'excited', delay: 1000 }
            ]
        });
        */
    </script>
</body>
</html>